#!/bin/bash

# Function to prompt for user confirmation
prompt_confirmation() {
    read -p "$1 (y/n): " response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo "Operation aborted."
        exit 1
    fi
}

# Prompt user to confirm the start of the installation
prompt_confirmation "This script will guide you through the Arch Linux installation process. Do you want to continue?"

# Launch cfdisk for manual partitioning
echo "Launching cfdisk for manual partitioning..."
cfdisk

# Prompt user to confirm partitioning
prompt_confirmation "Have you completed partitioning with cfdisk and are ready to proceed?"

# Prompt user to specify the root partition
read -p "Enter the device name of the root partition (e.g., /dev/sda1): " root_partition

# Format the root partition
echo "Formatting the root partition..."
mkfs.ext4 "$root_partition"

# Prompt user to specify the EFI partition (if applicable)
read -p "Enter the device name of the EFI partition (e.g., /dev/sda2) or press Enter to skip: " efi_partition

if [ -n "$efi_partition" ]; then
    # Format the EFI partition
    echo "Formatting the EFI partition..."
    mkfs.fat -F32 "$efi_partition"
fi

# Mount the root partition
echo "Mounting the root partition..."
mount "$root_partition" /mnt

if [ -n "$efi_partition" ]; then
    # Create EFI mount point and mount the EFI partition
    echo "Creating EFI mount point and mounting the EFI partition..."
    mkdir -p /mnt/boot/efi
    mount "$efi_partition" /mnt/boot/efi
fi

# Install the base system
echo "Installing the base system..."
pacstrap /mnt base linux linux-firmware

# Generate fstab
echo "Generating fstab..."
genfstab -U /mnt >> /mnt/etc/fstab

# Chroot into the new system
echo "Chrooting into the new system..."
arch-chroot /mnt /bin/bash <<EOF
# Set the timezone
echo "Setting the timezone..."
ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
hwclock --systohc

# Set the locale
echo "Setting the locale..."
echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
locale-gen
echo "LANG=en_US.UTF-8" > /etc/locale.conf

# Set the hostname
read -p "Enter the hostname: " hostname
echo "$hostname" > /etc/hostname

# Configure hosts file
cat <<EOL > /etc/hosts
127.0.0.1    localhost
::1          localhost
127.0.1.1    $hostname.localdomain    $hostname
EOL

# Set the root password
echo "Setting the root password..."
passwd

# Install and configure the bootloader
echo "Installing and configuring the bootloader..."
pacman -S --noconfirm grub
grub-install --target=i386-pc /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg

EOF

# Unmount and reboot
echo "Unmounting and rebooting..."
umount -R /mnt
reboot
